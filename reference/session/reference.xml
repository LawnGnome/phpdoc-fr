<?xml version="1.0" encoding="iso-8859-1"?>
<!-- $Revision: 1.5 $ -->
 <reference id="ref.session">
  <title>Sessions</title>
  <titleabbrev>Sessions</titleabbrev>
	
  <partintro>
   <para>
    Le support des sessions de PHP est un moyen de pr&eacute;server
    des donn&eacute;es entre plusieurs acc&egrave;s. Cela vous permet de
    cr&eacute;er des applications personnalis&eacute;es, et d'augmenter 
    l'attractivit&eacute; de votre site.
   </para>
   <para>
    SI vous &ecirc;tes familier avec la gestion de session de la 
    librairie PHPLIB, vous remarquerez que certains concepts
    sont similaires.
   </para>
   <para>
    Chaque visiteur acc&eacute;dant &agrave; votre page web se voit assign&eacute; un
    identifiant unique, appel&eacute; 'identifiant de session'. Il peut
    &ecirc;tre stock&eacute; soit dans un cookie, soit propag&eacute; dans l'URL.
   </para>
   <para>
    Le support des sessions vous permet d'enregistrer un
    nombre illimit&eacute; de variables qui doivent &ecirc;tre pr&eacute;serv&eacute;es
    entre les requ&ecirc;tes. Lorsqu'un visiteur acc&egrave;de &agrave; votre site,
    PHP va v&eacute;rifier automatiquement (si session.auto_start est
    activ&eacute;1)  ou sur demande (explicitement avec 
    <function>session_start</function> ou  implicitement avec 
    <function>session_register</function>) si il existe une
    session du m&ecirc;me nom. Si c'est le cas, l'environnement
    pr&eacute;c&eacute;demment sauv&eacute; sera recr&eacute;&eacute;.
   </para>
   <para>
    Toutes les variables sont s&eacute;rialis&eacute;es apr&egrave;s l'ex&eacute;cution du
    script PHP. Les variables qui sont ind&eacute;finies sont marqu&eacute;es
    comme telles. Lors des acc&egrave;s ult&eacute;rieurs, elles ne seront pas
    d&eacute;finies, jusqu'&agrave; ce que l'utilisateur le fasse.
   </para>
   <para>
    Les options de configuration 
    <link linkend="ini.track-vars"><literal>track_vars</literal></link> et 
    <link linkend="ini.register-globals"><literal>register_globals</literal></link> 
    influencent la mani&egrave;re de stockage et d&eacute;stockage des variables.
   </para>
   <note>
    <para>
     Depuis PHP 4.0.3, <link linkend="ini.track-vars"><literal>track_vars</literal></link>
     est toujours activ&eacute;.
    </para>
   </note>
   <note>
    <para>
     Depuis PHP 4.1.0, <varname>$_SESSION</varname> est disponible
     comme variable tout comme <varname>$_POST</varname>,
     <varname>$_GET</varname>, <varname>$_REQUEST</varname>, etc..
     Contrairement &agrave; <varname>$HTTP_SESSION_VARS</varname>,
     <varname>$_SESSION</varname> est toujours global. Par cons&eacute;quent,
     <literal>global</literal> should not be used for
     <varname>$_SESSION</varname>.
    </para>
   </note>
   <para>
    Si <link linkend="ini.track-vars"><literal>track_vars</literal></link> est
    activ&eacute; et <link linkend="ini.register-globals"><literal>register_globals</literal></link>
    est d&eacute;sactiv&eacute;, seuls les &eacute;l&eacute;ments du tableau global
    <varname>$HTTP_SESSION_VARS</varname> contiendront les variables 
    enregistr&eacute;es dans la session. Les variables de sessions relues seront
    uniquement disponibles dans <varname>$HTTP_SESSION_VARS</varname>.
    <example>
     <title>
      Enregistrer une variable avec 
      <link linkend="ini.track-vars"><literal>track_vars</literal></link>
      activ&eacute;
     </title>
     <programlisting role="php">
<![CDATA[
<?php
session_start();
if (isset($HTTP_SESSION_VARS['compteur'])) {
   $HTTP_SESSION_VARS['compteur']++;
}
else {
   $HTTP_SESSION_VARS['compteur'] = 0;
}
?>
]]>
     </programlisting>
    </example>
   </para>
   <para>
    L'utilisation de la variable <varname>$_SESSION</varname> (ou
    <varname>$HTTP_SESSION_VARS</varname> avec PHP 4.0.6 ou plus ancien)
    est recommand&eacute; pour des raisons de s&eacute;curit&eacute; et de lisibilit&eacute; du
    code. Avec <varname>$_SESSION</varname> et
    <varname>$HTTP_SESSION_VARS</varname>, il n'y a pas besoin
    d'utiliser les fonctions 
    <function>session_register</function>, <function>session_unregister</function>
    et <function>session_is_registered</function>. Les utilisateurs peuvent
    utiliser une variable de session comme toute variable classique.
    <example>
     <title>
      Enregistrer une variable avec $_SESSION.
     </title>
     <programlisting role="php">
<![CDATA[
<?php
session_start();
// Utilisez $HTTP_SESSION_VARS avec PHP 4.0.6 ou plus ancien
if (!isset($_SESSION['count'])) {
    $_SESSION['count'] = 0;
} else {
    $_SESSION['count']++;
}
?>
]]>
     </programlisting>
    </example>
    <example>
     <title>
      Annuler l'enregistrement d'une variable avec $_SESSION.
     </title>
     <programlisting role="php">
<![CDATA[
<?php
session_start();
// Utilisez $HTTP_SESSION_VARS avec PHP 4.0.6 ou plus ancien
unset($_SESSION['count']);
?>
]]>
     </programlisting>
    </example>
   </para>
   <para>
    Si <link linkend="ini.register-globals"><literal>register_globals</literal></link>
    est activ&eacute;, alors toutes les variables globales peuvent &ecirc;tre
    enregistr&eacute;es comme variables de session, et toutes les variables de sessions
    seront reconstitu&eacute;es comme variables globales. Comme PHP doit
    savoir quels variables globales sont enregistr&eacute;es comme variables
    de sessions, l'utilisateur doit enregistrer  les variables avec
    <function>session_register</function> tandis que 
    <varname>$HTTP_SESSION_VARS</varname> et <varname>$_SESSION</varname>
    ne n&eacute;cessitent pas <function>session_register</function>.
    <caution>
     <para>
      Si vous utilisez 
      <varname>$HTTP_SESSION_VARS</varname> et <varname>$_SESSION</varname>
      et d&eacute;sactivez <link linkend="ini.register-globals"><literal>register_globals</literal></link>,
      n'utilisez pas <function>session_register</function>,
      <function>session_is_registered</function> et
      <function>session_unregister</function>.
     </para>
     <para>
      Si vous activez <link linkend="ini.register-globals"><literal>register_globals</literal></link>,
       <function>session_unregister</function> doit &ecirc;tre utilis&eacute;, car les
       variables de session sont enregistr&eacute;s comme variables globales lorsque
       les donn&eacute;es de sessions sont relues. Inactiver 
       <link linkend="ini.register-globals"><literal>register_globals</literal></link>
       est recommand&eacute; pour des raisons de s&eacute;curit&eacute; et de performances.
     </para>
    </caution>
    <example>
     <title>
      Enregistrer une variable avec 
      <link linkend="ini.register-globals"><literal>register_globals</literal></link>
      activ&eacute;
     </title>
     <programlisting role="php">
<![CDATA[
<?php
if (!session_is_registered('compteur')) {
    session_register("compteur");
    $compteur = 0;
}
else {
    $compteur++;
}
?>
]]>
     </programlisting>
    </example>
   </para>
   <para>
    Si les deux options 
    <link linkend="ini.track-vars"><literal>track_vars</literal></link> et
    <link linkend="ini.register-globals"><literal>register_globals</literal></link>
    sont activ&eacute;s, alors les variables globales
    <varname>$HTTP_SESSION_VARS</varname>/<varname>$_SESSION</varname>
    repr&eacute;senteront les m&ecirc;mes valeurs que celles qui sont enregistr&eacute;es avec les
    variables de m&ecirc;me nom.
   </para>
   <para>
    Si l'utilisateur utilise <function>session_register</function> pour
    enregistrer des variables de sessions, 
    <varname>$HTTP_SESSION_VARS</varname>/<varname>$_SESSION</varname>
    ne contiendront pas ces variables jusqu'&agrave; ce le tableau soit
    de nouveau g&eacute;n&eacute;r&eacute;s &agrave; partir des informations stock&eacute;es en session.
   </para>
   <para>
    Il y a deux m&eacute;thodes de propagation de l'identifiant de session : 
    <itemizedlist>
     <listitem>
      <simpara>
       Cookies
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       Param&egrave;ter URL
      </simpara>
     </listitem>
    </itemizedlist>
   </para>
   <para>
    Le module de session supporte les deux m&eacute;thodes. Les cookies sont 
    optimaux, mais comme ils ne sont pas sûrs (tous les internautes 
    ne les acceptent pas), ils ne sont pas fiables. La seconde
    m&eacute;thode place l'identifiant de session directement dans les URL.
   </para>
   <para>
    PHP est de faire cela de mani&egrave;re transparente, lorsqu'il est compil&eacute;
    avec l'option <link linkend="install.configure.enable-trans-sid">
    <literal>--enable-trans-sid</literal></link>. Si vous activez
    cette option, les URL relatives seront modifi&eacute;es pour contenir
    l'identifiant de session automatiquement. Alternativement,
    vous pouvez utiliser la constante <constant>SID</constant>, qui est
    d&eacute;finie, si le client n'a pas envoy&eacute; le cookie appropri&eacute;. 
    <constant>SID</constant> est soit de la forme 
    <literal>session_name=session_id</literal> ou une chaîne vide.
    <note>
     <para>
     L'option <link linkend="ini.arg_separator.output">arg_separator.output</link>
     de &php.ini; vous permet de personnaliser le s&eacute;parateur d'arguments.
     </para>
    </note> 
   </para>
   <para>
    LMexemple suivant vous montre comment enregistrer une variable et comment
    r&eacute;aliser un lien correct avec une autre page, avec <constant>SID</constant>.
    <example>
     <title>Compter le nombre de hits d'un utilisateur sur une page</title>
     <programlisting role="php">
<![CDATA[
<?php
if (!session_is_registered('compteur')) {
    session_register('compteur');
    $compteur = 1;
}
else {
    $compteur++;
}
?>

Bonjour visiteur, vous avez vu cette page <?php echo $compteur; ?> fois.<p>;

<?php
// Le <?php echo SID?> (<?=SID?> est aussi possible suivant votre configuration)
// est n&eacute;cessaire pour pr&eacute;server l'identifiant de sessions
// si jamais l'utilisateur a d&eacute;sactiv&eacute; les cookies.
?>

Pour continuer, <A HREF="nextpage.php?<?php echo SID?>">cliquez ici</A>.
]]>
     </programlisting>
    </example>
   </para>
   <para>
    <literal>&lt;?=SID?&gt;</literal> n'est pas n&eacute;cessair, si
    <link linkend="install.configure.enable-trans-sid">
    <literal>--enable-trans-sid</literal></link> a &eacute;t&eacute; activ&eacute; &agrave; la compilation de PHP.
   </para>
   <note>
    <para>
     Les URLS non relatives sont consid&eacute;r&eacute;es comme externes au site, et ne
     recevront pas le SID, car c'est une fuite d'information vers un autre
     site (envoi d'informations importantes).
    </para>
   </note>
   <para>
    Pour impl&eacute;menter un stockage en base de donn&eacute;es, ou toute autre m&eacute;thode,
    vous aurez besoin de la fonction <function>session_set_save_handler</function> pour
    param&eacute;trer vos propres fonctions de stockage.
   </para>
   <para>
    Le syst&egrave;me de session supporte un grand nombre d'options, que vous pouvez
    placer dans le fichier &php.ini; file. En voici une pr&eacute;sentation.
    <itemizedlist>
     <listitem>
      <simpara>
       <literal>session.save_handler</literal> defines the name of the
       handler which is used for storing and retrieving data
       associated with a session.  Defaults to
       <literal>files</literal>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.save_path</literal> d&eacute;finit le chemin qui
       doit &ecirc;tre pass&eacute; au gestionnaire de sauvegarde. Si vous 
       d&eacute;cidez de choisir le gestionnaire par d&eacute;faut (par fichier),
       cet argument sera utilis&eacute; comme dossier de sauvegarde
       des sessions. Par d&eacute;faut, il vaut <filename>/tmp</filename>. Si
       le niveau d'imbrication de <literal>session.save_path</literal>
       est sup&eacute;rieur &agrave; 2, le nettoyage des sessions obsol&egrave;tes ne s'op&eacute;rera
       pas.
      </simpara>
      <warning>
       <para>
        Si vous laissez cette option configur&eacute;e avec un dossier
        accessible en lecture &agrave; tout le monde, comme par exemple
        <filename>/tmp</filename> (par d&eacute;faut), les autres utilisateurs
        pourront exploiter ces sessions en obtenant la liste de fichiers
        dans ce dossier.
       </para>
      </warning>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.name</literal> sp&eacute;cifie le nom de la session,
       qui sera utilis&eacute; comme nom de cookie. Il ne doit contenir que
       des caract&egrave;res alphanum&eacute;rique. Par d&eacute;faut, c'est
       <literal>PHPSESSID</literal>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.auto_start</literal> sp&eacute;cifie si le module
       de session doit d&eacute;marrer automatiquement, au d&eacute;but de
       chaque script PHP. Par d&eacute;faut, c'est <literal>0</literal> (inactiv&eacute;).
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.cookie_lifetime</literal> sp&eacute;cifie la dur&eacute;e de
       vie du cookie en secondes. La valeur de <literal>0</literal>
       siginifie : "Jusqu'&agrave; ce que le navigateur soit &eacute;teind".
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.serialize_handler</literal> d&eacute;finit le nom
       du gestionnaire qui est utilis&eacute; pour lin&eacute;ariser/d&eacute;lin&eacute;ariser
       les donn&eacute;es. Actuellement, un format interne &agrave; PHP
       (nomm&eacute; <literal>php</literal>) et WDDX (nomm&eacute;
       <literal>wddx</literal>) sont support&eacute;s . WDDX est seulement 
       disponible, si PHP a &eacute;t&eacute; compil&eacute; avec l'option
       <link linkend="ref.wddx">WDDX</link>. Par d&eacute;faut, c'est <literal>php</literal>.
       </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.gc_probability</literal> specifies the
       probability that the gc (garbage collection) routine is started
       on each request in percent. Defaults to <literal>1</literal>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.gc_maxlifetime</literal> sp&eacute;cifie la dur&eacute;e de
       vie des donn&eacute;es sur le serveur, en nombre de secondes. Apr&egrave;s
       cette dur&eacute;e, les donn&eacute;es seront consid&eacute;r&eacute;es comme obsol&egrave;tes,
       et supprim&eacute;es.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.referer_check</literal> contient une sous-chaîne
       que vous souhaitez retrouver dans tous les ent&ecirc;tes HTTP Referer. Si
       cet ent&ecirc;tes a &eacute;t&eacute; envoy&eacute; par le client, et que la sous-chaîne n'a pas
       &eacute;t&eacute; trouv&eacute;, l'identifiant de session sera consid&eacute;r&eacute; comme invalide. 
       Par d&eacute;faut, cette option est la chaîne vide.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.entropy_file</literal> est un chemin jusqu'&agrave;
       une source externe (un fichier), qui sera utilis&eacute;e comme source
       additionnelle d'entropie pour la cr&eacute;ation de l'identifiant
       de session. Des exemples valides sont <literal>/dev/random</literal> et
       <literal>/dev/urandom</literal>, qui sont disponibles sur
       tous les syst&egrave;mes Unix.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.entropy_length</literal> sp&eacute;cifie le nombre d'octets
       qui seront lus dans le fichier d&eacute;fini ci-dessus. Par d&eacute;faut, il
       vaut <literal>0</literal>, c'est &agrave; dire inactif.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.use_cookies</literal> sp&eacute;cifie si le module utilisera
       les cookies pour stocker les donn&eacute;es de session sur le client.
       Par d&eacute;faut, il vaut <literal>1</literal>, c'est &agrave; dire actif.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.use_only_cookies</literal> sp&eacute;cifie si le module
       doit utiliser <emphasis role="strong">seulement</emphasis> les cookies
       pour stocker les identifiants de sessions du cot&eacute; du navigateur. Par d&eacute;faut,
       cette option vaut <literal>0</literal> (inactif, pour compatibilit&eacute; ascendante).
       En l'activant, vous &eacute;viterez les attaques qui utilisent des
       identifiants de sessions dans les URL. Cette configuration a &eacute;t&eacute; ajout&eacute;e
       en PHP 4.3.0.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.cookie_path</literal> sp&eacute;cifie le chemin utilis&eacute;
       lors de la cr&eacute;ation du cookie. Par d&eacute;faut, il vaut <literal>/</literal>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.cookie_domain</literal> sp&eacute;cifie le domaine utilis&eacute;
       lors de la cr&eacute;ation du cookie. Par d&eacute;faut, il ne vaut rien.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.cache_limiter</literal> sp&eacute;cifie le type de
       contrôle de cache utilis&eacute; pour les pages avec sessions. Les
       valeurs possibles sont : 
       none, nocache, private, private_no_expire, public. Par d&eacute;faut, il vaut
       <literal>nocache</literal>.
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.cache_expire</literal> sp&eacute;cifie la dur&eacute;e de
       vie des donn&eacute;es de sessions, en minute. Cette option n'a aucune
       cons&eacute;quence sur le contrôle de cache. Par d&eacute;faut, il vaut
       <literal>180</literal> (3 heures).
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>session.use_trans_sid</literal> indique si le
       support transparent du SID est activ&eacute;, gr&acirc;ce &agrave; l'option
       de compilation <link linkend="install.configure.enable-trans-sid">
       <literal>--enable-trans-sid</literal></link>.
       Par d&eacute;faut, il vaut <literal>1</literal> (activ&eacute;).
      </simpara>
     </listitem>
     <listitem>
      <simpara>
       <literal>url_rewriter.tags</literal> sp&eacute;cifie quels sont les balises 
       HTML qui doivent &ecirc;tre r&eacute;&eacute;crites si le support transparent du SID
       est activ&eacute;. Par d&eacute;faut, il vaut
       <literal>a=href,area=href,frame=src,input=src,form=fakeentry</literal>
      </simpara>
     </listitem>
    </itemizedlist>
    <note>
     <para>
      La gestion des sessions a &eacute;t&eacute; ajout&eacute;e en PHP 4.0.
     </para>
    </note>
   </para>
  </partintro>

&reference.session.functions;

 </reference>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"../../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
