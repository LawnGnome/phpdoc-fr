<?xml version="1.0" encoding="iso-8859-1"?>
<!-- $Revision: 1.3 $ -->
 <chapter id="features.safe-mode">
  <title>Safe mode</title>
  <para>
   Le "Safe Mode" est le mode de s&eacute;curit&eacute; de PHP : une solution au probl&egrave;me
   de partage de PHP sur un serveur. Ce syst&egrave;me p&ecirc;che au niveau de l'architecture
   car il n'est pas correct de tenter de r&eacute;soudre ce probl&egrave;me au niveau
   de PHP, mais les solutions alternatives bas&eacute;es sur le serveur web et l'OS
   ne sont pas r&eacute;alistes. De nombreux acteurs, notamment les fournisseurs
   d'h&eacute;bergement, utilise le "Safe Mode".
  </para>
  <para>
   Les directives de configuration qui contr&ocirc;lent le safe mode sont :
   <informalexample>
    <programlisting role="ini">
safe_mode = Off
open_basedir =
safe_mode_exec_dir =
safe_mode_allowed_env_vars = PHP_
safe_mode_protected_env_vars = LD_LIBRARY_PATH
disable_functions =
    </programlisting>
   </informalexample>
  </para>
  <para>
   Lorsque <link linkend="ini.safe-mode">safe_mode</link> est actif, 
   PHP v&eacute;rifie que le propri&eacute;taire du script
   courant est le m&ecirc;me que le propri&eacute;taire des
   fichiers qui seront manipul&eacute;s par ce script. Par exemple, 
   dans a la situation suivante :
   <informalexample>
    <programlisting role="ls">
-rw-rw-r--    1 rasmus   rasmus       33 Jul  1 19:20 script.php
-rw-r--r--    1 root     root       1116 May 26 18:01 /etc/passwd
    </programlisting>
   </informalexample>
   &eacute;x&eacute;cuter le script <filename>script.php</filename>
   <informalexample>
    <programlisting role="php">
&lt;?php
 readfile('/etc/passwd');
?&gt;
    </programlisting>
   </informalexample>
   g&eacute;n&eacute;rera cette erreur, si le safe mode est activ&eacute; :
   <informalexample>
    <programlisting>
Warning: SAFE MODE Restriction in effect. The script whose uid is 500 is not
allowed to access /etc/passwd owned by uid 0 in /docroot/script.php on line 2
   </programlisting>
  </informalexample>
 </para>
  <para>
   Si vou utilisez la directive open_basedir au lieu du 
   <link linkend="ini.safe-mode">safe_mode</link>, alors les
   manipulations seront limit&eacute;es aux fichiers situ&eacute;s dans les dossiers
   sp&eacute;cifi&eacute;s. Par exemple :
   <informalexample>
    <programlisting role="ini">
&lt;Directory /docroot&gt;
php_admin_value open_basedir /docroot
&lt;/Directory&gt;
   </programlisting>
  </informalexample>
  Si vous ex&eacute;cutez le script <filename>script.php</filename> ci-dessus avec
   la configuration d'open_basedir le r&eacute;sultat sera l'affichage suivant :
   <informalexample>
    <programlisting role="php">
Warning: open_basedir restriction in effect. File is in wrong directory in
/docroot/script.php on line 2
    </programlisting>
   </informalexample>
  </para>
  <para>
   Vous pouvez aussi d&eacute;sactiver individuellement les fonctions. Par exemple,
   en ajoutant cette ligne dans le fichier <filename>php.ini</filename> :
   <informalexample>
    <programlisting role="ini">
disable_functions readfile,system
    </programlisting>
   </informalexample>
   toute utilisation des fonctions <function>readfile</function> et
   <function>system</function> g&eacute;n&eacute;rera l'affichage suivant :
   <informalexample>
    <programlisting role="php">
Warning: readfile() has been disabled for security reasons in
/docroot/script.php on line 2
    </programlisting>
   </informalexample>
  </para>

  <sect1 id="features.safe-mode.functions">
   <title>Functions d&eacute;sactiv&eacute;es par le Safe Mode</title>
   <para>
    Voici une liste non-exhaustive des fonctions d&eacute;sactiv&eacute;es par
    le <link linkend="features.safe-mode">Safe Mode</link>.
    <!-- TODO: add &note.sm.*; to the functions mentioned here.
    That entity should link to this section -->
    <table>
     <title>Fonctions d&eacute;sactiv&eacute;es par le Safe Mode</title>
     <tgroup cols="2">
      <thead>
       <row>
        <entry>Fonction</entry>
        <entry>Limitations</entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry><function>dbmopen</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>dbase_open</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro_rowcount</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>filepro_retrieve</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry>Fonctions ifx_</entry>
        <entry>restrictions sql_safe_mode, (!= Safe Mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry>Fonctions ingres_</entry>
        <entry>restrictions sql_safe_mode, (!= Safe Mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry>Fonctions mysql_</entry>
        <entry>restrictions sql_safe_mode, (!= Safe Mode)</entry>
        <!-- TODO: more info on sql-safe-mode -->
       </row>
       <row>
        <entry><function>pg_loimport</function></entry>
        <entry>&sm.uidcheck;</entry>
        <!-- source TODO: there is no PHP-warning for that safe-mode-restriction -->
       </row>
       <row>
        <entry><function>posix_mkfifo</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>putenv</function></entry>
        <entry>Ob&eacute;is aux directives safe_mode_protected_env_vars et 
        safe_mode_allowed_env_vars. Voir aussi la documentation de 
        <function>putenv</function></entry>
        <!-- TODO: document those directives in chapters/config.xml -->
       </row>
       <row>
        <entry><function>move_uploaded_file</function></entry>
        <entry>&sm.uidcheck; <!-- TODO: check this --></entry>
       </row>

       <!-- TODO: from here on, add warning to the function itself -->

       <row>
        <entry><function>chdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>dl</function></entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><link linkend="language.operators.execution">backtick operator</link></entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><function>shell_exec</function> (&eacute;quivalent fonctionnels
        des guillemets oblique)</entry>
        <entry>&sm.disabled;</entry>
       </row>
       <row>
        <entry><function>exec</function></entry>
        <entry>
         Vous ne pouvez &eacute;x&eacute;cuter que les programmes qui
         sont dans le dossier <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
         Pour des raisons pratiques, il n'est pas possible d'utiliser des
         jokers comme <literal>..</literal> dans le chemin de ce dossier.
        </entry>
       </row>
       <row>
        <entry><function>system</function></entry>
        <entry>
         Vous ne pouvez &eacute;x&eacute;cuter que les programmes qui
         sont dans le dossier <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
         Pour des raisons pratiques, il n'est pas possible d'utiliser des
         jokers comme <literal>..</literal> dans le chemin de ce dossier.
        </entry>
       </row>
       <row>
        <entry><function>passthru</function></entry>
        <entry>
         Vous ne pouvez &eacute;x&eacute;cuter que les programmes qui
         sont dans le dossier <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
         Pour des raisons pratiques, il n'est pas possible d'utiliser des
         jokers comme <literal>..</literal> dans le chemin de ce dossier.
        </entry>
       </row>
       <row>
        <entry><function>popen</function></entry>
        <entry>
         Vous ne pouvez &eacute;x&eacute;cuter que les programmes qui
         sont dans le dossier <link linkend="ini.safe-mode-exec-dir">safe_mode_exec_dir</link>.
         Pour des raisons pratiques, il n'est pas possible d'utiliser des
         jokers comme <literal>..</literal> dans le chemin de ce dossier.
        </entry>
        <!-- TODO: not sure. popen uses a completely different implementation
        Don't know why, don't know whether it's behaving the same -->
       </row>
       <row>
        <entry><function>mkdir</function></entry>
        <entry>&sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>rmdir</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>rename</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;<!-- on the old name only, it seems. Is rename preventing moving files? --></entry>
       </row>
       <row>
        <entry><function>unlink</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>copy</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; (on 
        <parameter>source</parameter> and 
        <parameter>target</parameter>) </entry>
       </row>
       <row>
        <entry><function>chgrp</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>chown</function></entry>
        <entry>&sm.uidcheck;</entry>
       </row>
       <row>
        <entry><function>chmod</function></entry>
        <entry>&sm.uidcheck; De plus, vous ne pouvez pas modifier les
        SUID, SGID et sticky bit</entry>
       </row>
       <row>
        <entry><function>touch</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir;</entry>
       </row>
       <row>
        <entry><function>symlink</function></entry>
        <entry>&sm.uidcheck; &sm.uidcheck.dir; (note: only the target is 
        checked)</entry>
       </row>
       <row>
        <entry><function>link</function></entry>
        <entry>
         &sm.uidcheck; &sm.uidcheck.dir; (note: seule le fichier
         de destination est v&eacute;rifi&eacute;.
        </entry>
       </row>
       <row>
        <entry><function>getallheaders</function></entry>
        <entry>
         En Safe Mode, les ent&ecirc;tes commencants par 'authorization' 
         (sensible &agrave; la casse) ne seront pas retourn&eacute;s. Attention :
         cette protection est mise en d&eacute;faut par la fonction
         <function>getallheaders</function> sur les serveurs AOL!
        </entry>
       </row>
       <row>
        <entry>
         Toutes les fonctions qui utilisent les
         wrappers de fichiers.
        </entry>
        <entry>??</entry>
       </row>
      </tbody>
     </tgroup>
    </table>
   </para>
  </sect1>

 </chapter>
<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:nil
sgml-default-dtd-file:"../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
-->
